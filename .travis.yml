language: node_js
os: linux
dist: xenial
node_js:
- '12'
services:
- mongodb
cache: yarn
branches:
  only:
  - main
env:
  global:
  - PORT=3000
  - MONGODB_URL=mongodb://localhost:27017/app
  - JWT_SECRET=thisisasamplesecret
  - JWT_ACCESS_EXPIRATION_MINUTES=30
  - JWT_REFRESH_EXPIRATION_DAYS=30
script:
- yarn lint
- yarn test
after_success: yarn coverage:coveralls
# deploy:
#   provider: lambda
#   function_name: cs3219-task-b
#   region: ap-southeast-1
#   role: arn:aws:iam::165735147686:role/cs3129-lambda
#   runtime: nodejs12.x
#   handler_name: handler
#   on:
#     all_branches: true
#   access_key_id:
#     secure: eL7i9e8hcON3CGIDTLB5lVUxOxN0SJJzSFWbbLtrGtMubpPEeAw+pnaPUkEKlnh6Zf1hLCqbykUBLV8qDq4hE2VzHZwU4dwWtszalzXFStq0sYjXQQ42+p9nWsD5R43Gyb6iimznh/tsKIhv+mONvrmfYEtgXjUbH3esEQ6grRGkUIM8a+LEWgeO5t1vq/HBhbzbcCKoDX/kQTP5K+fkusWxEwPuVIjeIVGn4hMgx8GFxSiXT2DPkjGP2wyV3usCqfP2bq1dRGITXt5Vx5+m6ICRtG6l7UsGIiygDJOqdFPT10co9HMX3yIumNjyGWUTNwMhe1gpEugN93ecNaF/qZ3h87iRZU+xgQp9i7gE8ir3pigaYVO/71BpOHaTJ/SyUGFjsFpWOHUb+WhkCpa2OICA/ZpIF62cd6qvZ49N8i5Uz33lYCrDnMYJZSlzMbMvYN391X319nJ0hchIhPjJ+Hd6jSWY1YldfC4tF4ZY2JYKUXTVDTQTq8GQo00dt3442+tEoqHSUO8EaFnOeee5DEj+tYVea4FV3CwdniP0hSlVBdTAMpq+4jeV6Mp/wxbVfPaU9ZRxzrLgaRrSA9I7K/KkU4wPDihlzoqks1h2I59fR7uK50su9joKf04p8/ltkQ9kfUZUlBY7Pq534WVBi/vqGsan/5L3MXoM7FWOzo4=
#   secret_access_key:
#     secure: ZDEQZTvl2FMsUXtCE+WMSscsQd3FRWxsPF+FT/3lPxe0QeSsb8pGRl/krzKeCXv0OHZnAaWRRQdtipCQxRK37vBVMJv/f3RWl5956SOzud2qC1U4mhzVBNgMpYBVfW8XJgDFwWTSfVQOmuSZHM95PPiHtHN8atay7NFJIkQC3pajCXqjunOlWj5nZjK8N3Fukkea9fpcr8Gxd9iZvdbKFCI041DPedjmJXY/MyAgLujFyaZ19x6hX6kHl3Zoaw4EOvfiDFMKDaWyPw2ESc52pKsw7ooRQrrXt1RR6HhP5rhcxfJwb45OP9IkOvXDJRVJNKyRiyqpKm+VX65Yer6RlQBtWYpjYXrypmjzNGmbov2DFFIBsa15sCpZxusFWUYJ++aNGMXeIAhaX83pjCSgegW2unOKhA3mg9zZMWdXOiusSVejZeBrHYPTlg+CfQQgB+5rpOOMtBEz0A2AG+Od+13OLiMRSiugJkoZP7l6+w6JpDwrdkZ45KQojvKB/Ocu4h0qy/v4qHNCiiPyE6iAikXKpvcBZkPdqNIPJuhgv8wqbJln5k0gHhWbAeuGM3TvAcxoEB0DirLjUSHodluwp8mkC2psG2cmR+e4e/Wp8UgRsp8GVQMzzUFYP9anaXsY6yvhl5I0AGxdTU/XCQUxUFRjhiENaOPAX3fNJJwK5TM=
#   env:
#     global:
#     - secure: SvFmXkm1sHl6e6+dOdvuuTurDuUjRTwfKVFfpjPUm2/T6gOhQ2i0NRHZWED6fSoDVISyX/eoJiSiJZexZd4rNNsvLxwXtqQ1Z6HA9ZEoQNrNB42F6YBpJVHw/aINuA5wbM3Po8phPk2goW9zR34K8BN+s9EBM/kva+zmqOOSQtJJrOO02BjSqYhXAVjVv0PNo1VeNPNt8pwY//XXCGUFacMuC5guWl8KjOsjUZKT8QQGgcqrxZ/mvEl5Fer273/UvS//vCsYU23foQldM0zqgVV9tumpNLXJLfiHQ54vIMoIf04tkdgiaqo8EwwyBVvhDDpAw7d0NlyxXi5V5NAybz09DHh/QCXoXIwDNuB2Upj3pimEJvoZOT5+/8RpRjKyPKfiyWiNRve7POE5qcd3ra5n9L/2IlQVcnroC4XrEV/KpoulRfkzxZ9hZ5LvhM3Ur9CTemxQ5o68h6MhmVNrXyYdalTvGxnVRMavFCLpVLLUZjhaxGimD6bpJ+eJjkx35FFptd2O12zb1Z0NCAJOqlSJzVH7NAn6FivP8cp0pSTHUR+dl8ZQAiplep22YASQMkn2I28qaP3v4wru1T6XprGXzIlWT95VE0PhBPzzOgywmFXJz5rXbOiGg9MwPx4twpoHnbLPtaV4cW9KAgqFJG4SqTf6WwOORnAnlDZLqzs=
#     - secure: J5LbXy4CDmgbJGn1z1o55VX/AzS0otsl3ygNqASKAhvDrv9NK4KfVo6sWMAsb6QOvqVkY6owhKEOFt4WTd9ZfHstgH2heEKfE8c1OiR9HaQC9jeLi8YB4LzLTXn6Y/YvD1mvesVlHWQFPdZDHgtiuE08IpR1f+O3MQmgB4Soxmz279BdWPyv7ziTZocPFPVT1JRIa4aKtGLSOgdYG/ZIeqRAGtDurougfszKR8f53I8YwmbJsZFPj6VQFwgsR5qWFlJGZfL7f6rFFrFjC4C70aCWG2cKOTjwAA2tT1RsWlx82+gGcp8ehlGFXYoOwEwTAOIgtZNdoPeYctEbQqAdbm/v1aeH4xODfm9ESHipRLx2kjtLtfwi7m5xsPzk1Xgjckh6NhnQxxNx35jpHjIlUKQhXEBJQu1bh/avN0csr83OeeMCzzl5DYw+v1Jy7vW9Z4w/YqL8iGdzLyV34HaG0e24OTvcKb+dXseHL5hseR//pP48ZbRZ/byCOphWljg1lQHh0UGWu9LAMujBym+aExG7la6PaDuZRidRMAqboNG72zywNBJD26DYAiBalYIDajo2VDiB7J9fJH+xBHJQKrlC3AYp9HMrlNoAeKydTyk0Ulv4gK2FbBcbyJqxCVNh0Xz2JqOY1W6d244hFuFFY3rRWybvcYPz9ls7iYTMB+Y=
#     - secure: D6WRdgx3xqiqotv08JD+1jZwWcZatYgU1KKuQwAAVvLyqLqVW2o3WQ7Y6vvRW/BRF4wJ6lZ2PMkSba3zwdMNSZBT4daohqsrqLA4ztR1bIbnwwip/YK2AazLyTt08qduv48aqroudk0QT+prQLZ9phMyTrBYFbzNaPmjxTaG5Z4Fa+B5pal3wxUyt1Ul736kJvlQd12YWHy4hoNonlkkLmYDV8K9BIXQ7Jfxhh/Eg65HMeHc1Q6uaTJGAAezJD17oDQuRUwYplTJCBcJ8PZCD0yj9abrZlaWFa+6nIdqfqLNaZhnn0voa985WywvSOEuMWXUwPMxPFR5ee+DaDce6c66GWI93OdgleoLHduLx3bAYve8XgvwTfULthoQqc2dEDKYeMiKIgqlwcZruccvn3K7NQkcSDTkJJuRA5V0A5iVoJIArWYxsJkhrSMLW9seeMe/K+zbOszBTVcAry9trDK8KXIBNoZczdhUjiVUUnA/1Yh8nAwZQGquTOFggNx4ge1cYUvKCZ2tW141xszXQNpAjWM2fckroIc5hf6cjXtMq57faIhdHyM3sQe99potJiFVJf7feLoyLUTuDXEuLaOLFYTAFuboo771l11FENdXj5kpMEQ+dYVtueZpAIGwQQcp4FZPxhKUczr5zJKxfhUNJMFotFdFLqCSDuglke0=
#     - secure: qPBc/ZiZoVeEOzYE5NFc/HBOc/VcEAATEQwQm5JI1lQpZlGu4Ist4vvm3J3wCJXlSFzLCqkvx+3utjieWzaW4yEIWuFbnLlp4artWMnpmdRcWH0fFyME9YIZfVIsHVXa3e1+lFKcNIIor/xxvvjDsHTzy0UNqMFp+ojDTcNzXWdbYq2FoHlEsvckbBjEB6M1iP3ZOFrf0EhtgbC9PosSORrZ9RYdN2DX8htTj+n+7wcX1AGvXUyIQ/uqsOCfGk+wVamvGoScvs2656xwq0NOadqt1o2QT+Mb36Y/5K852XKk5BQmrR+wMGodE6BuJth1//8NI/YiZuROfhhD0227suqjPDDjWYkjR8bm2aASomUjCLDoiXKP3xFSnOB7E8RlGIQT62CvnS8WgJqol31AfPM0v3/yAliK5gb3xcd1kZj9wkdVYYdRqm7goaf/rEqJLEQY1JyBo2MFgN/xuJdguCtb6Q2XUlxP3XU8qciwJ4C4qecSstunlQjiQKRTo9+H+w4VnZd5ZKb3WtGzDYfyzVhdUzW6YbKXFkDwW8q4UKD6LtPMqC94Ehvus/CKbIw5s99s1AKl08Ub6wGM2gDJ7HagIHGX/2GtMh285XUNFJ+xmEYOkYOiJkT7B/9rtZVoja7cu1rFoc99/9gePVfEobIrvTG297GL7db+F1XUVkA=
#     - secure: scCRn4v2bRQmf7moKAoBnLuM4x+yi75flpjrXfcAqEU24PJHxbgCdvtjmigt1KbqmzC8O8AnAp/uCRkcWETDAozjWMsRybgV46VfxL9dg/cVWEowGFj8flY6qx9yD2wDDL8iXd7clNZ2ic/zWFT7zOXOz+r5E1PNryG2y1fqe4zibFt+OLnVxx36c2iocsrHsQvjb/CzfVzbLOAD8RjYEvwzeKaQ04RgZpKaMNx4AfVWlP9INHwusQYNxtT+51VAL5SSHhsSXXm6RgNgB2gb0qM8GbR9/H4n84lB40FViPsc+R01e3fN7HknvDpwcfdNczqtO9UcvHkn5XjxDshl9nhGbMMCZWazjd3Wy1gP9v7uYfiFDok0r46THByCOHvFjs0ipoRbv5uyQ6Mh5I2lgs3lOaoxt8WBV/VY6n1FvM65qG6B0f8Mb5j4dRNRHdTpMLKP2GATlfds8a9mca7Jqdw226bmr87vfIfOsYz271/FSyBAsWQypOsPBhsBWROEQej5yIWLY9hNt1TvmwolM+asYHL7IctxdfMlw5CJCKxCEvyg8chu6ioaq+szquIGQIFOkCN/LnowOXyMvRCr2SGANUresG0KMGWmT/nl/5rMCxvpKxaA51x/IYroAVR35eTiFO35EvXAuKelzkDd+noJOG7kP2gpvyXzQcj1PFI=
deploy_service_job: &DEPLOY_SERVICE_JOB
  cache:
    directories:
      - node_modules
      - ${SERVICE_PATH}/node_modules

  install:
    - npm install -g serverless
    - travis_retry npm install
    - cd ${SERVICE_PATH}
    - travis_retry npm install
    - cd -

  script:
    - cd ${SERVICE_PATH}
    - serverless deploy -s ${STAGE_NAME}
    - cd -

environments:
  # - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  # - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
  - secure: SvFmXkm1sHl6e6+dOdvuuTurDuUjRTwfKVFfpjPUm2/T6gOhQ2i0NRHZWED6fSoDVISyX/eoJiSiJZexZd4rNNsvLxwXtqQ1Z6HA9ZEoQNrNB42F6YBpJVHw/aINuA5wbM3Po8phPk2goW9zR34K8BN+s9EBM/kva+zmqOOSQtJJrOO02BjSqYhXAVjVv0PNo1VeNPNt8pwY//XXCGUFacMuC5guWl8KjOsjUZKT8QQGgcqrxZ/mvEl5Fer273/UvS//vCsYU23foQldM0zqgVV9tumpNLXJLfiHQ54vIMoIf04tkdgiaqo8EwwyBVvhDDpAw7d0NlyxXi5V5NAybz09DHh/QCXoXIwDNuB2Upj3pimEJvoZOT5+/8RpRjKyPKfiyWiNRve7POE5qcd3ra5n9L/2IlQVcnroC4XrEV/KpoulRfkzxZ9hZ5LvhM3Ur9CTemxQ5o68h6MhmVNrXyYdalTvGxnVRMavFCLpVLLUZjhaxGimD6bpJ+eJjkx35FFptd2O12zb1Z0NCAJOqlSJzVH7NAn6FivP8cp0pSTHUR+dl8ZQAiplep22YASQMkn2I28qaP3v4wru1T6XprGXzIlWT95VE0PhBPzzOgywmFXJz5rXbOiGg9MwPx4twpoHnbLPtaV4cW9KAgqFJG4SqTf6WwOORnAnlDZLqzs=
  - secure: J5LbXy4CDmgbJGn1z1o55VX/AzS0otsl3ygNqASKAhvDrv9NK4KfVo6sWMAsb6QOvqVkY6owhKEOFt4WTd9ZfHstgH2heEKfE8c1OiR9HaQC9jeLi8YB4LzLTXn6Y/YvD1mvesVlHWQFPdZDHgtiuE08IpR1f+O3MQmgB4Soxmz279BdWPyv7ziTZocPFPVT1JRIa4aKtGLSOgdYG/ZIeqRAGtDurougfszKR8f53I8YwmbJsZFPj6VQFwgsR5qWFlJGZfL7f6rFFrFjC4C70aCWG2cKOTjwAA2tT1RsWlx82+gGcp8ehlGFXYoOwEwTAOIgtZNdoPeYctEbQqAdbm/v1aeH4xODfm9ESHipRLx2kjtLtfwi7m5xsPzk1Xgjckh6NhnQxxNx35jpHjIlUKQhXEBJQu1bh/avN0csr83OeeMCzzl5DYw+v1Jy7vW9Z4w/YqL8iGdzLyV34HaG0e24OTvcKb+dXseHL5hseR//pP48ZbRZ/byCOphWljg1lQHh0UGWu9LAMujBym+aExG7la6PaDuZRidRMAqboNG72zywNBJD26DYAiBalYIDajo2VDiB7J9fJH+xBHJQKrlC3AYp9HMrlNoAeKydTyk0Ulv4gK2FbBcbyJqxCVNh0Xz2JqOY1W6d244hFuFFY3rRWybvcYPz9ls7iYTMB+Y=
  - secure: D6WRdgx3xqiqotv08JD+1jZwWcZatYgU1KKuQwAAVvLyqLqVW2o3WQ7Y6vvRW/BRF4wJ6lZ2PMkSba3zwdMNSZBT4daohqsrqLA4ztR1bIbnwwip/YK2AazLyTt08qduv48aqroudk0QT+prQLZ9phMyTrBYFbzNaPmjxTaG5Z4Fa+B5pal3wxUyt1Ul736kJvlQd12YWHy4hoNonlkkLmYDV8K9BIXQ7Jfxhh/Eg65HMeHc1Q6uaTJGAAezJD17oDQuRUwYplTJCBcJ8PZCD0yj9abrZlaWFa+6nIdqfqLNaZhnn0voa985WywvSOEuMWXUwPMxPFR5ee+DaDce6c66GWI93OdgleoLHduLx3bAYve8XgvwTfULthoQqc2dEDKYeMiKIgqlwcZruccvn3K7NQkcSDTkJJuRA5V0A5iVoJIArWYxsJkhrSMLW9seeMe/K+zbOszBTVcAry9trDK8KXIBNoZczdhUjiVUUnA/1Yh8nAwZQGquTOFggNx4ge1cYUvKCZ2tW141xszXQNpAjWM2fckroIc5hf6cjXtMq57faIhdHyM3sQe99potJiFVJf7feLoyLUTuDXEuLaOLFYTAFuboo771l11FENdXj5kpMEQ+dYVtueZpAIGwQQcp4FZPxhKUczr5zJKxfhUNJMFotFdFLqCSDuglke0=
  - secure: qPBc/ZiZoVeEOzYE5NFc/HBOc/VcEAATEQwQm5JI1lQpZlGu4Ist4vvm3J3wCJXlSFzLCqkvx+3utjieWzaW4yEIWuFbnLlp4artWMnpmdRcWH0fFyME9YIZfVIsHVXa3e1+lFKcNIIor/xxvvjDsHTzy0UNqMFp+ojDTcNzXWdbYq2FoHlEsvckbBjEB6M1iP3ZOFrf0EhtgbC9PosSORrZ9RYdN2DX8htTj+n+7wcX1AGvXUyIQ/uqsOCfGk+wVamvGoScvs2656xwq0NOadqt1o2QT+Mb36Y/5K852XKk5BQmrR+wMGodE6BuJth1//8NI/YiZuROfhhD0227suqjPDDjWYkjR8bm2aASomUjCLDoiXKP3xFSnOB7E8RlGIQT62CvnS8WgJqol31AfPM0v3/yAliK5gb3xcd1kZj9wkdVYYdRqm7goaf/rEqJLEQY1JyBo2MFgN/xuJdguCtb6Q2XUlxP3XU8qciwJ4C4qecSstunlQjiQKRTo9+H+w4VnZd5ZKb3WtGzDYfyzVhdUzW6YbKXFkDwW8q4UKD6LtPMqC94Ehvus/CKbIw5s99s1AKl08Ub6wGM2gDJ7HagIHGX/2GtMh285XUNFJ+xmEYOkYOiJkT7B/9rtZVoja7cu1rFoc99/9gePVfEobIrvTG297GL7db+F1XUVkA=
  - secure: scCRn4v2bRQmf7moKAoBnLuM4x+yi75flpjrXfcAqEU24PJHxbgCdvtjmigt1KbqmzC8O8AnAp/uCRkcWETDAozjWMsRybgV46VfxL9dg/cVWEowGFj8flY6qx9yD2wDDL8iXd7clNZ2ic/zWFT7zOXOz+r5E1PNryG2y1fqe4zibFt+OLnVxx36c2iocsrHsQvjb/CzfVzbLOAD8RjYEvwzeKaQ04RgZpKaMNx4AfVWlP9INHwusQYNxtT+51VAL5SSHhsSXXm6RgNgB2gb0qM8GbR9/H4n84lB40FViPsc+R01e3fN7HknvDpwcfdNczqtO9UcvHkn5XjxDshl9nhGbMMCZWazjd3Wy1gP9v7uYfiFDok0r46THByCOHvFjs0ipoRbv5uyQ6Mh5I2lgs3lOaoxt8WBV/VY6n1FvM65qG6B0f8Mb5j4dRNRHdTpMLKP2GATlfds8a9mca7Jqdw226bmr87vfIfOsYz271/FSyBAsWQypOsPBhsBWROEQej5yIWLY9hNt1TvmwolM+asYHL7IctxdfMlw5CJCKxCEvyg8chu6ioaq+szquIGQIFOkCN/LnowOXyMvRCr2SGANUresG0KMGWmT/nl/5rMCxvpKxaA51x/IYroAVR35eTiFO35EvXAuKelzkDd+noJOG7kP2gpvyXzQcj1PFI=

jobs:
  include:
    # master branch deploys to the 'prod' stage
    - <<: *DEPLOY_SERVICE_JOB
      name: "Deploy API"
      if: type = push AND branch = main
      env:
        - SERVICE_PATH="."
        - STAGE_NAME=dev